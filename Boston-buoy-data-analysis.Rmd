---
title: "Boston Buoy Data Analysis"
author: "Hao"
date: "2020/9/22"
output:   
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(ggplot2,lubridate,stringr,tidyverse,ggpubr,knitr)
load('Buoy.Rdata')
```

# Summary

In this report, we formed conclusion that there is evidence showing global warming after we analyzed the Boston Buoy Data set from 1987 to 2016, with total 246,245 observations. The whole analysis process is consisted by four part:

* Read data from URLs of NOAA and combined into a single data.frame.

* Transform separated time variables into one and deleted NA observations.

* Perform data analysis with WTMP *(Water Temperature)* 

* Perform data analysis with ATMP *(Air Temperature)*

As a result, from annual perspective, the analysis revealed that both the annual mean water temperature and air temperature shows slightly upward trends (0.005413$^{\circ}C/year$C/year, 0.003434$^{\circ}C/year$C/year respectively) as indications of global warming. Then, from monthly perspective, 8 out of 12 months of a year shows annually increasing trends on average water (Jan, Feb, Jul, Nov.) and air temperature (Jan, Feb, Mar, Nov). Besides, the upward trends of temperature in summer and downward trends of temperature in winter indicate an increase in extreme weather which is also a indicator of global warming.

# Data reading and combination

Initially, we thought this would be the simplest process, since Professor Haviland had uploaded Web crawler script. However, due to different formats and different amount of variables, the code needed to improve.

At first, we chose to separate the single 'for' loop into two, one for downloading data from NOAA and one to deal with formats issues, which has two advantages. First, it is helpful to deal with network issues, especially when try to connect from China. No timeout will interrupt other process. Second, it is much more easier to compare difference of data from different years, which is necessary for further combination.

```{}
url1="http://www.ndbc.noaa.gov/view_text_file.php?filename=mlrf1h"
url2=".txt.gz&dir=data/historical/stdmet/"
years=c(1987:2016)
urls=paste0(url1,years,url2)
Dnames=paste0('D',years)
for(i in years) assign(Dnames[i-years[1]+1],read_table2(urls[i-years[1]+1]))
```

# Combine, clean and transfer data
### Combine data
```{}
coln=colnames(get(Dnames[1]))
for(i in years){
  D=get(Dnames[i-years[1]+1])
  # From Y2000 to Y2016, delete an additional variable of 'TIDE'
  if(i %in% 2000:2016){D=select(D,-TIDE)}
  # From Y2005 to Y2016, delete an additional variable of 'mm'
  if(i %in% 2005:2016){D=select(D,-mm)}
  # From Y2007 to Y2016, delete first row of units
  if(i %in% 2007:2016){D=D[-1,]}
  # Check and unify col names and set data type as 'numeric'
  if(ncol(D)==length(coln)){colnames(D)=coln}
  D=sapply(D, as.numeric)
  # From Y1987 to Y1999, transfer the Year from 'XX' to '19XX'
  D[,1][D[,1]<100]=D[,1][D[,1]<100]+1900
  # Create and combine to form final data set Buoy
  if(i==years[1]){Buoy=D}
  else{Buoy=rbind.data.frame(Buoy,D)}
}
```
```{r}
kable(Buoy[1:5, ],caption="Buoy")
```

### Transfer data
```{}
#Time transfer
Buoy$DT=make_datetime(Buoy$YY,Buoy$MM,Buoy$DD,Buoy$hh)
Buoy=Buoy[,-c(2:4)]
save(Buoy,file='Buoy.Rdata')
```

# Prepare for analysis
```{r}
load('Buoy.Rdata')
month=c('Jan','Feb','Mar','Apr','May','Jun',
        'Jul','Aug','Sep','Oct','Nov','Dec')
```

# Analysis using 'Water Temperature'
### Delete those lines with 999.0 and 99.0
```{r}
Buoy_W=Buoy[Buoy$WTMP<99,]
```

### Trend of average temperature per year
```{r}
Y_W=0
for(i in 1988:2015){
  Y_W[i-1987]=mean(Buoy_W$WTMP
                   [date(Buoy_W$DT)>=make_date(i)&
                       date(Buoy_W$DT)<make_date(i+1)]
                   )
}
D_W=data.frame(Time=1988:2015,TMP=Y_W)
M_W=lm(TMP~Time,data=D_W)
print(M_W)
P_W=ggplot(D_W,aes(Time,TMP))+
  geom_point()+
  geom_smooth(method="lm",formula=y~x)+
  labs(title='Yearly Trend of Water Temperature', 
        x="year", y='Yearly Average Water Temperature')
P_W
```

### Trend of monthly average temperature per year
```{r}
M_W=0
P_WM_name=str_c('P_W',1:12,sep='')
for(j in 1:12){
  for(i in 1988:2015){
    M_W[i-1987]=mean(Buoy_W$WTMP
                     [date(Buoy_W$DT)>=
                         make_date(i,j)&
                         date(Buoy_W$DT)<
                         make_date(ifelse(j==12,i+1,i),
                                   ifelse(j==12,1,j+1))])
  }
  D_W=data.frame(Time=1988:2015,TMP=M_W)
  assign(P_WM_name[j],
         ggplot(D_W,aes(Time,TMP))+
         geom_point()+
         geom_smooth(method="lm",formula=y~x)+
         labs(title=month[j],x="year",y="Mean WTMP"))
}
ggarrange(P_W1,P_W2,P_W3,P_W4,P_W5,P_W6,ncol=3,nrow=2)
ggarrange(P_W7,P_W8,P_W9,P_W10,P_W11,P_W12,ncol=3,nrow=2)
```

# Analysis using 'Air Temperature'
### Delete those lines with 999.0 and 99.0
```{r}
Buoy_A=Buoy[Buoy$ATMP<99,]
```

### Trend of average temperature per year
```{r}
Y_A=0
for(i in 1988:2015){
  Y_A[i-1987]=mean(Buoy_A$ATMP
                   [date(Buoy_A$DT)>=make_date(i)&
                       date(Buoy_A$DT)<make_date(i+1)])
}
D_A=data.frame(Time=1988:2015,TMP=Y_A)
M_A=lm(TMP~Time,data=D_A)
print(M_A)
P_A=ggplot(D_A,aes(Time,TMP))+
  geom_point()+
  geom_smooth(method="lm",formula=y~x)+
  labs(title='Yearly Trend of Air Temperature', 
        x="year", y='Yearly Average Air Temperature')
P_A
```

### Trend of monthly average temperature per year
```{r}
M_A=0
P_AM_name=str_c('P_A',1:12,sep='')
for(j in 1:12){
  for(i in 1988:2015){
    M_A[i-1987]=mean(Buoy_A$ATMP
                     [date(Buoy_A$DT)>=
                         make_date(i,j)&
                         date(Buoy_A$DT)<
                         make_date(ifelse(j==12,i+1,i),
                                   ifelse(j==12,1,j+1))])
  }
  D_A=data.frame(Time=1988:2015,TMP=M_A)
  assign(P_AM_name[j],
         ggplot(D_A,aes(Time,TMP))+
         geom_point()+
         geom_smooth(method="lm",formula=y~x)+
         labs(title=month[j],x="year",y="Mean ATMP"))
}
ggarrange(P_A1,P_A2,P_A3,P_A4,P_A5,P_A6,ncol=3,nrow=2)
ggarrange(P_A7,P_A8,P_A9,P_A10,P_A11,P_A12,ncol=3,nrow=2)
```

# Conclusion
There is the evidence of global warming. The annually average water and air temperature are raising. 8 out of 12 months per year shows annually  increases in average water and air temperature.